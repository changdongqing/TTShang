@page "/identity/users"
@attribute [Authorize(IdentityPermissions.Users.Default)]
@using TTShang.AntDesignTheme.Blazor
@using Microsoft.AspNetCore.Authorization
@using TTShang.PermissionManagement.Blazor.Components
@using Microsoft.Extensions.Options
@using Volo.Abp.Identity
@using Volo.Abp.Identity.Localization
@using Volo.Abp.Data
@inject AbpBlazorMessageLocalizerHelper<IdentityResource> LH
@inject IIdentityUserAppService UserAppService
@inject IIdentityRoleAppService RoleAppService
@inherits Volo.Abp.AspNetCore.Components.AbpComponentBase
@implements IReuseTabsPage

<div class="user-management-container">
    @* Part 1: Breadcrumb and Toolbar - fixed height *@
    <div class="toolbar-section">
        <Row>
            <Col Span="12">
                <Breadcrumb>
                    <BreadcrumbItem Href="">
                        <Icon Type="home"/>
                    </BreadcrumbItem>
                    <BreadcrumbItem>@L["Menu:IdentityManagement"]</BreadcrumbItem>
                    <BreadcrumbItem>@L["Users"]</BreadcrumbItem>
                </Breadcrumb>
            </Col>
            <Col Span="12">
                <Row Justify="RowJustify.End">
                    <CrudToolbar 
                        AddButtonText="@L["NewUser"].Value"
                        DeleteButtonText="@L["Delete"].Value"
                        SaveButtonText="@L["Save"].Value"
                        PermissionsButtonText="@L["Permissions"].Value"
                        CreatePolicyName="@IdentityPermissions.Users.Create"
                        UpdatePolicyName="@IdentityPermissions.Users.Update"
                        DeletePolicyName="@IdentityPermissions.Users.Delete"
                        ManagePermissionsPolicyName="@IdentityPermissions.Users.ManagePermissions"
                        DeleteDisabled="@(!SelectedRows.Any())"
                        SaveDisabled="@(!HasChanges)"
                        PermissionsDisabled="@(SelectedRows.Count() != 1)"
                        OnAdd="@AddNewRow"
                        OnDelete="@DeleteSelectedRows"
                        OnSave="@SaveAllChanges"
                        OnPermissions="@OpenPermissionsModal" />
                </Row>
            </Col>
        </Row>
    </div>

    @* Part 2: Query Section - fixed height *@
    <div class="query-section">
        <Card>
            <Form Model="@QueryModel" Layout="@FormLayout.Inline">
                <FormItem Label="@L["DisplayName:UserName"].Value">
                    <Input @bind-Value="@QueryUserName" Placeholder="@L["DisplayName:UserName"].Value" Style="width: 150px;" />
                </FormItem>
                <FormItem Label="@L["DisplayName:Email"].Value">
                    <Input @bind-Value="@QueryEmail" Placeholder="@L["DisplayName:Email"].Value" Style="width: 180px;" />
                </FormItem>
                <FormItem Label="@L["DisplayName:PhoneNumber"].Value">
                    <Input @bind-Value="@QueryPhoneNumber" Placeholder="@L["DisplayName:PhoneNumber"].Value" Style="width: 150px;" />
                </FormItem>
            </Form>
            <div style="margin-top: 10px;">
                <Space>
                    <SpaceItem>
                        <Button Type="@ButtonType.Primary" OnClick="@SearchAsync">
                            <Icon Type="search" Theme="IconThemeType.Outline" Class="me-1"></Icon>
                            @L["Query"]
                        </Button>
                    </SpaceItem>
                    <SpaceItem>
                        <Button Type="@ButtonType.Default" OnClick="@ToggleAdvancedQuery">
                            <Icon Type="filter" Theme="IconThemeType.Outline" Class="me-1"></Icon>
                            @L["AdvancedQuery"]
                        </Button>
                    </SpaceItem>
                </Space>
            </div>
        </Card>
    </div>

    @* Part 3: Table with inline editing - adaptive height *@
    <div class="table-section">
        <Table @ref="TableRef"
               TItem="UserEditableRow"
               DataSource="@EditableUsers"
               Loading="@Loading"
               RowKey="x => x.Id"
               @bind-SelectedRows="@SelectedRows"
               ScrollY="@TableScrollY"
               ScrollX="@TableScrollX"
               Size="TableSize.Small"
               Bordered
               PaginationPosition="bottomRight"
               PageSize="@PageSize"
               Total="@TotalCount"
               PageIndex="@CurrentPage"
               OnChange="@OnTableChange">
            <Selection  />
            <Column TData="int" Title="@L["���"].Value" Width="60" Fixed="@ColumnFixPlacement.Left">
                @(EditableUsers.IndexOf(context) + 1 + (CurrentPage - 1) * PageSize)
            </Column>
            <Column TData="string" Title="@L["DisplayName:UserName"].Value" Width="120">
                @if (context.IsNew || context.IsEditing)
                {
                    <Input @bind-Value="@context.UserName" Size="@InputSize.Small" OnBlur="@(() => MarkAsModified(context))" />
                }
                else
                {
                    <span @ondblclick="@(() => StartEditing(context))">@context.UserName</span>
                }
            </Column>
            <Column TData="string" Title="@L["DisplayName:Surname"].Value" Width="100">
                @if (context.IsNew || context.IsEditing)
                {
                    <Input @bind-Value="@context.Surname" Size="@InputSize.Small" OnBlur="@(() => MarkAsModified(context))" />
                }
                else
                {
                    <span @ondblclick="@(() => StartEditing(context))">@context.Surname</span>
                }
            </Column>
            <Column TData="string" Title="@L["DisplayName:Name"].Value" Width="100">
                @if (context.IsNew || context.IsEditing)
                {
                    <Input @bind-Value="@context.Name" Size="@InputSize.Small" OnBlur="@(() => MarkAsModified(context))" />
                }
                else
                {
                    <span @ondblclick="@(() => StartEditing(context))">@context.Name</span>
                }
            </Column>
            <Column TData="string" Title="@L["DisplayName:Email"].Value" Width="180">
                @if (context.IsNew || context.IsEditing)
                {
                    <Input @bind-Value="@context.Email" Size="@InputSize.Small" OnBlur="@(() => MarkAsModified(context))" />
                }
                else
                {
                    <span @ondblclick="@(() => StartEditing(context))">@context.Email</span>
                }
            </Column>
            <Column TData="string" Title="@L["DisplayName:PhoneNumber"].Value" Width="130">
                @if (context.IsNew || context.IsEditing)
                {
                    <Input @bind-Value="@context.PhoneNumber" Size="@InputSize.Small" OnBlur="@(() => MarkAsModified(context))" />
                }
                else
                {
                    <span @ondblclick="@(() => StartEditing(context))">@context.PhoneNumber</span>
                }
            </Column>
            <Column TData="string" Title="@L["DisplayName:Password"].Value" Width="120">
                @if (context.IsNew || context.IsEditing)
                {
                    <InputPassword @bind-Value="@context.Password" Size="@InputSize.Small" OnBlur="@(() => MarkAsModified(context))" />
                }
                else
                {
                    <span @ondblclick="@(() => StartEditing(context))">******</span>
                }
            </Column>
            <Column TData="string" Title="@L["IdNumber"].Value" Width="180">
                @if (context.IsNew || context.IsEditing)
                {
                    <Input @bind-Value="@context.IdNumber" Size="@InputSize.Small" MaxLength="18" OnBlur="@(() => MarkAsModified(context))" />
                }
                else
                {
                    <span @ondblclick="@(() => StartEditing(context))">@context.IdNumber</span>
                }
            </Column>
            <Column TData="bool" Title="@L["IsThirdPartyEmployee"].Value" Width="120">
                @if (context.IsNew || context.IsEditing)
                {
                    <Select @bind-Value="@context.IsThirdPartyEmployee" 
                            TItem="bool" 
                            TItemValue="bool"
                            OnSelectedItemChanged="@(item => MarkAsModified(context))"
                            Style="width: 100%;">
                        <SelectOptions>
                            <SelectOption TItem="bool" TItemValue="bool" Value="true" Label="@L["Yes"].Value" />
                            <SelectOption TItem="bool" TItemValue="bool" Value="false" Label="@L["No"].Value" />
                        </SelectOptions>
                    </Select>
                }
                else
                {
                    <span @ondblclick="@(() => StartEditing(context))">@(context.IsThirdPartyEmployee ? L["Yes"] : L["No"])</span>
                }
            </Column>
            <Column TData="bool" Title="@L["DisplayName:IsActive"].Value" Width="80">
                @if (context.IsNew || context.IsEditing)
                {
                    <Checkbox @bind-Value="@context.IsActive" OnChange="@(val => MarkAsModified(context))" />
                }
                else
                {
                    <span @ondblclick="@(() => StartEditing(context))">
                        @if (context.IsActive)
                        {
                            <Icon Type="check" Theme="IconThemeType.Outline" Style="color: green;" />
                        }
                        else
                        {
                            <Icon Type="close" Theme="IconThemeType.Outline" Style="color: red;" />
                        }
                    </span>
                }
            </Column>
            <Column TData="bool" Title="@L["DisplayName:LockoutEnabled"].Value" Width="100">
                @if (context.IsNew || context.IsEditing)
                {
                    <Checkbox @bind-Value="@context.LockoutEnabled" OnChange="@(val => MarkAsModified(context))" />
                }
                else
                {
                    <span @ondblclick="@(() => StartEditing(context))">
                        @if (context.LockoutEnabled)
                        {
                            <Icon Type="check" Theme="IconThemeType.Outline" Style="color: green;" />
                        }
                        else
                        {
                            <Icon Type="close" Theme="IconThemeType.Outline" Style="color: red;" />
                        }
                    </span>
                }
            </Column>
            <Column TData="object" Title="@L["Roles"].Value" Width="200">
                @if (context.IsNew || context.IsEditing)
                {
                    <Select Mode="@SelectMode.Multiple"
                            @bind-Values="@context.RoleNames"
                            TItem="string"
                            TItemValue="string"
                            OnSelectedItemsChanged="@(items => MarkAsModified(context))"
                            Style="width: 100%;">
                        <SelectOptions>
                            @foreach (var role in AvailableRoles)
                            {
                                <SelectOption TItem="string" TItemValue="string" Value="@role.Name" Label="@role.Name" />
                            }
                        </SelectOptions>
                    </Select>
                }
                else
                {
                    <span @ondblclick="@(() => StartEditing(context))">@string.Join(", ", context.RoleNames ?? Array.Empty<string>())</span>
                }
            </Column>
        </Table>
    </div>
</div>

@if (HasManagePermissionsPermission)
{
    <PermissionManagementModal @ref="PermissionManagementModal" />
}

@code {
    public RenderFragment GetPageTitle() =>
    @<div>@L["Users"]</div>;
}
